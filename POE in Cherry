import uvicorn
from fastapi import FastAPI, Request
from fastapi.responses import StreamingResponse, HTMLResponse
from pydantic import BaseModel
import httpx
import json
import os
from dotenv import load_dotenv

# Load environment variables / åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# ================== Configuration / é…ç½® ==================
DEFAULT_CONFIG = {
    # Poe API Key (Recommended to set in .env file)
    "poe_api_key": os.getenv("POE_API_KEY", ""), 
    
    # Feature Toggles / åŠŸèƒ½å¼€å…³
    "enable_web_search": True,
    
    # Model Specific Settings / æ¨¡å‹ä¸“å±è®¾ç½®
    "claude_budget": 16000, # Tokens for Claude Thinking
    "gemini_budget": 16000, # Tokens for Gemini Thinking
    "gpt_effort": "high"    # Reasoning effort for O1/O3 (low, medium, high)
}

# Global Runtime Config / å…¨å±€è¿è¡Œæ—¶é…ç½®
current_config = DEFAULT_CONFIG.copy()

app = FastAPI(title="Poe API Proxy")

# ================== 1. WebUI (Embedded HTML) ==================
# A lightweight control panel to adjust settings on the fly.
# ä¸€ä¸ªè½»é‡çº§çš„æ§åˆ¶é¢æ¿ï¼Œç”¨äºå®æ—¶è°ƒæ•´ä»£ç†è®¾ç½®ã€‚

HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poe API Proxy Control</title>
    <style>
        :root { --primary: #0071e3; --bg: #f5f5f7; --card: #ffffff; --text: #1d1d1f; --border: #d2d2d7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; background-color: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
        .card { background: var(--card); padding: 30px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { margin: 0 0 25px 0; font-size: 22px; font-weight: 600; text-align: center; }
        .section-title { font-size: 13px; font-weight: 600; text-transform: uppercase; color: #86868b; margin-bottom: 10px; margin-top: 20px; letter-spacing: 0.5px; }
        .control-group { margin-bottom: 15px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; box-sizing: border-box; outline: none; transition: border 0.2s; }
        input[type="text"]:focus { border-color: var(--primary); }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; cursor: pointer; }
        .toggle-switch { position: relative; width: 50px; height: 30px; background-color: #e5e5e5; border-radius: 15px; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; width: 26px; height: 26px; border-radius: 50%; background: white; top: 2px; left: 2px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input[type="checkbox"] { display: none; }
        input[type="checkbox"]:checked + .toggle-switch { background-color: #34c759; }
        input[type="checkbox"]:checked + .toggle-switch::after { transform: translateX(20px); }
        .segmented-control { display: flex; background: #f0f0f0; padding: 3px; border-radius: 9px; margin-bottom: 10px; }
        .segment-btn { flex: 1; padding: 8px 0; text-align: center; font-size: 12px; font-weight: 500; color: #666; cursor: pointer; border-radius: 7px; transition: 0.2s; user-select: none; }
        .segment-btn.active { background: white; color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: 600; transform: scale(1); }
        .segment-btn:hover:not(.active) { background: rgba(255,255,255,0.5); }
        .label-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .current-val { font-size: 12px; color: var(--primary); font-weight: 600; }
        .save-btn { background-color: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 20px; transition: transform 0.1s; }
        .save-btn:active { transform: scale(0.98); }
        .status { text-align: center; margin-top: 15px; font-size: 13px; min-height: 20px; opacity: 0; transition: opacity 0.3s; }
        .status.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ› ï¸ Poe API Proxy</h1>
        
        <div class="control-group">
            <div class="section-title" style="margin-top: 0;">API Settings</div>
            <input type="text" id="apiKey" placeholder="Paste Poe API Key here (or use .env)">
        </div>

        <div class="control-group">
            <label class="toggle-row">
                <span style="font-weight: 500;">Web Search (è”ç½‘æœç´¢)</span>
                <input type="checkbox" id="webSearch">
                <div class="toggle-switch"></div>
            </label>
        </div>

        <div class="control-group">
            <div class="label-row">
                <div class="section-title">Claude Budget</div>
                <span id="disp_claude" class="current-val">16000</span>
            </div>
            <div class="segmented-control" id="claudeSegment">
                <div class="segment-btn" onclick="setBudget('claude', 4000, this)">4k</div>
                <div class="segment-btn" onclick="setBudget('claude', 8000, this)">8k</div>
                <div class="segment-btn" onclick="setBudget('claude', 16000, this)">16k</div>
                <div class="segment-btn" onclick="setBudget('claude', 24000, this)">24k</div>
                <div class="segment-btn" onclick="setBudget('claude', 32000, this)">32k</div>
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <div class="section-title">Gemini Budget</div>
                <span id="disp_gemini" class="current-val">16000</span>
            </div>
            <div class="segmented-control" id="geminiSegment">
                <div class="segment-btn" onclick="setBudget('gemini', 4000, this)">4k</div>
                <div class="segment-btn" onclick="setBudget('gemini', 8000, this)">8k</div>
                <div class="segment-btn" onclick="setBudget('gemini', 16000, this)">16k</div>
                <div class="segment-btn" onclick="setBudget('gemini', 24000, this)">24k</div>
                <div class="segment-btn" onclick="setBudget('gemini', 32000, this)">32k</div>
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <div class="section-title">GPT / O1 Reasoning Effort</div>
                <span id="disp_gpt" class="current-val">High</span>
            </div>
            <div class="segmented-control" id="gptSegment">
                <div class="segment-btn" onclick="setEffort('minimal', this)">Minimal</div>
                <div class="segment-btn" onclick="setEffort('low', this)">Low</div>
                <div class="segment-btn" onclick="setEffort('medium', this)">Medium</div>
                <div class="segment-btn active" onclick="setEffort('high', this)">High</div>
            </div>
        </div>

        <button class="save-btn" onclick="saveConfig()">Save Settings</button>
        <div id="status" class="status">âœ… Configuration Updated</div>
    </div>

    <script>
        let state = { claude_budget: 16000, gemini_budget: 16000, gpt_effort: 'high' };

        function setBudget(type, val, btn) {
            state[type + '_budget'] = val;
            document.getElementById('disp_' + type).innerText = val;
            const container = document.getElementById(type + 'Segment');
            container.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setEffort(val, btn) {
            state.gpt_effort = val;
            document.getElementById('disp_gpt').innerText = val.charAt(0).toUpperCase() + val.slice(1);
            const container = document.getElementById('gptSegment');
            container.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function highlightBtnByValue(type, value) {
            const container = document.getElementById(type + 'Segment');
            const btns = container.querySelectorAll('.segment-btn');
            btns.forEach(btn => {
                if (btn.getAttribute('onclick').includes(value)) { btn.classList.add('active'); } 
                else { btn.classList.remove('active'); }
            });
            document.getElementById('disp_' + type).innerText = value;
        }

        window.onload = async () => {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                document.getElementById('apiKey').value = config.poe_api_key;
                document.getElementById('webSearch').checked = config.enable_web_search;
                state.claude_budget = config.claude_budget;
                state.gemini_budget = config.gemini_budget;
                state.gpt_effort = config.gpt_effort;

                highlightBtnByValue('claude', config.claude_budget);
                highlightBtnByValue('gemini', config.gemini_budget);
                
                const gptContainer = document.getElementById('gptSegment');
                gptContainer.querySelectorAll('.segment-btn').forEach(b => {
                    b.classList.remove('active');
                    if(b.innerText.toLowerCase() === config.gpt_effort) b.classList.add('active');
                });
                document.getElementById('disp_gpt').innerText = config.gpt_effort.charAt(0).toUpperCase() + config.gpt_effort.slice(1);
            } catch(e) { console.error("Load failed", e); }
        };

        async function saveConfig() {
            const config = {
                poe_api_key: document.getElementById('apiKey').value,
                enable_web_search: document.getElementById('webSearch').checked,
                claude_budget: state.claude_budget,
                gemini_budget: state.gemini_budget,
                gpt_effort: state.gpt_effort
            };
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                const statusDiv = document.getElementById('status');
                if(res.ok) {
                    statusDiv.classList.add('show');
                    setTimeout(() => statusDiv.classList.remove('show'), 2000);
                }
            } catch(e) { alert('Connection Error'); }
        }
    </script>
</body>
</html>
"""

class ConfigModel(BaseModel):
    poe_api_key: str
    enable_web_search: bool
    claude_budget: int
    gemini_budget: int
    gpt_effort: str


# ================== 2. Management Endpoints / ç®¡ç†æ¥å£ ==================

@app.get("/", response_class=HTMLResponse)
async def serve_ui():
    return HTML_TEMPLATE

@app.get("/api/config")
async def get_config():
    return current_config

@app.post("/api/config")
async def set_config(config: ConfigModel):
    global current_config
    current_config = config.dict()
    # Log simplified for general usage
    print(f"[Config] Updated: WebSearch={current_config['enable_web_search']} | Claude={current_config['claude_budget']} | GPT={current_config['gpt_effort']}")
    return {"status": "success", "config": current_config}

# ================== 3. Core Proxy Logic / æ ¸å¿ƒä»£ç†é€»è¾‘ ==================

@app.post("/v1/chat/completions")
async def chat_proxy(request: Request):
    """
    OpenAI-compatible endpoint that forwards requests to Poe.
    Handles parameter sanitization and injection.
    """
    cfg = current_config
    
    try:
        original_body = await request.json()
    except:
        original_body = {}

    model_name = original_body.get("model", "").lower()
    poe_payload = original_body.copy()
    
    # =========================================================================
    # [CRITICAL FIX] Parameter Sanitization / å‚æ•°æ¸…æ´—
    # 
    # Context: Clients like Cherry Studio/NextChat send 'stream_options' to request
    # token usage stats during streaming. Poe API does not support this and returns
    # "Unknown parameter" (400 Error).
    #
    # Solution: We must strictly remove these unsupported keys before forwarding.
    # 
    # èƒŒæ™¯: Cherry Studio ç­‰å®¢æˆ·ç«¯åœ¨æµå¼è¾“å‡ºæ—¶ä¼šå‘é€ stream_options è¯·æ±‚ Token ç»Ÿè®¡ï¼Œ
    # ä½† Poe API æš‚ä¸æ”¯æŒè¯¥å‚æ•°å¹¶ä¼šæŠ¥é”™ 400ã€‚å¿…é¡»åœ¨è½¬å‘å‰æ¸…æ´—æ‰ã€‚
    # =========================================================================
    keys_to_clean = [
        "reasoning_effort", # We inject this manually later based on config
        "thinking_budget",  # We inject this manually later based on config
        "stream_options",   # <--- The culprit for "Unknown parameter" errors
        "logit_bias",       # Not supported by Poe
        "logprobs",         # Not supported by Poe
        "top_logprobs"      # Not supported by Poe
    ]
    for k in keys_to_clean:
        poe_payload.pop(k, None)
    
    # Flatten extra_body if present
    if "extra_body" in poe_payload:
        extra = poe_payload.pop("extra_body")
        if isinstance(extra, dict): poe_payload.update(extra)

    # ================== Parameter Injection / å‚æ•°æ³¨å…¥ ==================
    injected_logs = []

    # 1. Inject Web Search / æ³¨å…¥è”ç½‘æœç´¢
    if cfg["enable_web_search"]:
        poe_payload["web_search"] = True
        injected_logs.append("Search:ON")

    # 2. Inject Thinking/Effort Parameters / æ³¨å…¥æ€è€ƒé¢„ç®—
    if "claude" in model_name and cfg["claude_budget"] > 0:
        poe_payload["thinking_budget"] = cfg["claude_budget"]
        injected_logs.append(f"ClaudeBudget:{cfg['claude_budget']}")
        
    elif "gemini" in model_name and cfg["gemini_budget"] > 0:
        poe_payload["thinking_budget"] = cfg["gemini_budget"]
        injected_logs.append(f"GeminiBudget:{cfg['gemini_budget']}")
        
    else:
        # GPT/O1 Models
        if cfg["enable_web_search"] and cfg["gpt_effort"]:
            # Inject standard reasoning effort
            poe_payload["reasoning_effort"] = cfg["gpt_effort"]
            injected_logs.append(f"GPTEffort:{cfg['gpt_effort']}")

    print(f"[{model_name}] Proxying... | {', '.join(injected_logs)}")
    
    headers = {
        "Content-Type": "application/json", 
        "Authorization": f"Bearer {cfg['poe_api_key']}"
    }
    target_url = "https://api.poe.com/v1/chat/completions"

    # ================== Upstream Request with Retry / ä¸Šæ¸¸è¯·æ±‚ä¸é‡è¯• ==================
    timeout_config = httpx.Timeout(connect=60.0, read=None, write=60.0, pool=None)

    async def upstream_generator():
        max_retries = 2
        async with httpx.AsyncClient(timeout=timeout_config, http2=False) as client:
            for attempt in range(max_retries):
                try:
                    async with client.stream("POST", target_url, json=poe_payload, headers=headers) as response:
                        if response.status_code != 200:
                            # Capture and return error message from Poe
                            err = b"".join([chunk async for chunk in response.aiter_bytes()]).decode()
                            print(f"âŒ Poe API Error: {err}")
                            yield err.encode()
                            return
                        
                        async for chunk in response.aiter_bytes():
                            yield chunk
                        return # Success

                except Exception as e:
                    print(f"âš ï¸ Connection Warning (Attempt {attempt+1}/{max_retries}): {e}")
                    if attempt == max_retries - 1:
                        yield f'{{"error": "Poe Proxy Timeout. Detail: {str(e)}"}}'.encode()

    return StreamingResponse(upstream_generator(), media_type="text/event-stream")

if __name__ == "__main__":
    print("ğŸš€ Poe Proxy Started: http://127.0.0.1:8001")
    uvicorn.run(app, host="127.0.0.1", port=8001)

