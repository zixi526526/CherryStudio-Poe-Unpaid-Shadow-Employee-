import uvicorn
from fastapi import FastAPI, Request
from fastapi.responses import StreamingResponse, HTMLResponse
from pydantic import BaseModel
import httpx
import json
import os
from dotenv import load_dotenv

# åŠ è½½ .env
load_dotenv()

# ================== é»˜è®¤é…ç½® ==================
DEFAULT_CONFIG = {
    "poe_api_key": os.getenv("POE_API_KEY", ""), 
    "enable_web_search": True,
    "claude_budget": 16000, # é»˜è®¤å€¼éœ€åœ¨æ¡£ä½ä¸­
    "gemini_budget": 16000,
    "gpt_effort": "high"
}

# å…¨å±€é…ç½®
current_config = DEFAULT_CONFIG.copy()

app = FastAPI()

# ================== 1. WebUI 2.0 (å…¨æŒ‰é’®æ§åˆ¶ç‰ˆ) ==================
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poe æ™ºèƒ½æ§åˆ¶å°</title>
    <style>
        :root { --primary: #0071e3; --bg: #f5f5f7; --card: #ffffff; --text: #1d1d1f; --border: #d2d2d7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; max-width: 500px; margin: 40px auto; padding: 20px; background-color: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
        
        /* å¡ç‰‡é£æ ¼ */
        .card { background: var(--card); padding: 30px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { margin: 0 0 25px 0; font-size: 22px; font-weight: 600; text-align: center; }
        
        .section-title { font-size: 13px; font-weight: 600; text-transform: uppercase; color: #86868b; margin-bottom: 10px; margin-top: 20px; letter-spacing: 0.5px; }
        .control-group { margin-bottom: 15px; }
        
        /* è¾“å…¥æ¡† */
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; box-sizing: border-box; outline: none; transition: border 0.2s; }
        input[type="text"]:focus { border-color: var(--primary); }

        /* å¼€å…³ (Toggle Switch) */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; cursor: pointer; }
        .toggle-switch { position: relative; width: 50px; height: 30px; background-color: #e5e5e5; border-radius: 15px; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; width: 26px; height: 26px; border-radius: 50%; background: white; top: 2px; left: 2px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input[type="checkbox"] { display: none; }
        input[type="checkbox"]:checked + .toggle-switch { background-color: #34c759; }
        input[type="checkbox"]:checked + .toggle-switch::after { transform: translateX(20px); }

        /* åˆ†æ®µæ§åˆ¶å™¨ (Segmented Control) */
        .segmented-control { display: flex; background: #f0f0f0; padding: 3px; border-radius: 9px; margin-bottom: 10px; }
        .segment-btn { flex: 1; padding: 8px 0; text-align: center; font-size: 12px; font-weight: 500; color: #666; cursor: pointer; border-radius: 7px; transition: 0.2s; user-select: none; }
        .segment-btn.active { background: white; color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: 600; transform: scale(1); }
        .segment-btn:hover:not(.active) { background: rgba(255,255,255,0.5); }

        /* æ ‡ç­¾å¤´ä¼˜åŒ– */
        .label-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; }
        .current-val { font-size: 12px; color: var(--primary); font-weight: 600; }

        /* æŒ‰é’® */
        .save-btn { background-color: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 20px; transition: transform 0.1s; }
        .save-btn:active { transform: scale(0.98); }
        
        .status { text-align: center; margin-top: 15px; font-size: 13px; min-height: 20px; opacity: 0; transition: opacity 0.3s; }
        .status.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ› ï¸ Poe æ™ºèƒ½æ§åˆ¶å°</h1>
        
        <div class="control-group">
            <div class="section-title" style="margin-top: 0;">åŸºç¡€è®¾ç½®</div>
            <input type="text" id="apiKey" placeholder="åœ¨æ­¤ç²˜è´´ Poe API Key (å¦‚ .env ä¸ºç©º)">
        </div>

        <div class="control-group">
            <label class="toggle-row">
                <span style="font-weight: 500;">è”ç½‘æœç´¢ (Web Search)</span>
                <input type="checkbox" id="webSearch">
                <div class="toggle-switch"></div>
            </label>
        </div>

        <div class="control-group">
            <div class="label-row">
                <div class="section-title">Claude Budget</div>
                <span id="disp_claude" class="current-val">16000</span>
            </div>
            <div class="segmented-control" id="claudeSegment">
                <div class="segment-btn" onclick="setBudget('claude', 4000, this)">4k</div>
                <div class="segment-btn" onclick="setBudget('claude', 8000, this)">8k</div>
                <div class="segment-btn" onclick="setBudget('claude', 16000, this)">16k</div>
                <div class="segment-btn" onclick="setBudget('claude', 24000, this)">24k</div>
                <div class="segment-btn" onclick="setBudget('claude', 32000, this)">32k</div>
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <div class="section-title">Gemini Budget</div>
                <span id="disp_gemini" class="current-val">16000</span>
            </div>
            <div class="segmented-control" id="geminiSegment">
                <div class="segment-btn" onclick="setBudget('gemini', 4000, this)">4k</div>
                <div class="segment-btn" onclick="setBudget('gemini', 8000, this)">8k</div>
                <div class="segment-btn" onclick="setBudget('gemini', 16000, this)">16k</div>
                <div class="segment-btn" onclick="setBudget('gemini', 24000, this)">24k</div>
                <div class="segment-btn" onclick="setBudget('gemini', 32000, this)">32k</div>
            </div>
        </div>

        <div class="control-group">
            <div class="label-row">
                <div class="section-title">GPT / O1 Reasoning Effort</div>
                <span id="disp_gpt" class="current-val">High</span>
            </div>
            <div class="segmented-control" id="gptSegment">
                <div class="segment-btn" onclick="setEffort('minimal', this)">Minimal</div>
                <div class="segment-btn" onclick="setEffort('low', this)">Low</div>
                <div class="segment-btn" onclick="setEffort('medium', this)">Medium</div>
                <div class="segment-btn active" onclick="setEffort('high', this)">High</div>
            </div>
        </div>

        <button class="save-btn" onclick="saveConfig()">ä¿å­˜å¹¶ç”Ÿæ•ˆ</button>
        <div id="status" class="status">âœ… é…ç½®å·²æ›´æ–°</div>
    </div>

    <script>
        // æœ¬åœ°çŠ¶æ€å­˜å‚¨
        let state = {
            claude_budget: 16000,
            gemini_budget: 16000,
            gpt_effort: 'high'
        };

        // è®¾ç½® Budget (Claude / Gemini)
        function setBudget(type, val, btn) {
            state[type + '_budget'] = val;
            
            // æ›´æ–° UI æ–‡å­—
            document.getElementById('disp_' + type).innerText = val;
            
            // æ›´æ–°æŒ‰é’®é«˜äº®
            const container = document.getElementById(type + 'Segment');
            container.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // è®¾ç½® Effort (GPT)
        function setEffort(val, btn) {
            state.gpt_effort = val;
            
            // æ›´æ–° UI æ–‡å­—
            document.getElementById('disp_gpt').innerText = val.charAt(0).toUpperCase() + val.slice(1);

            // æ›´æ–°æŒ‰é’®é«˜äº®
            const container = document.getElementById('gptSegment');
            container.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // è¾…åŠ©ï¼šæ ¹æ®æ•°å€¼æ‰¾åˆ°å¯¹åº”æŒ‰é’®å¹¶æ¿€æ´»
        function highlightBtnByValue(type, value) {
            const container = document.getElementById(type + 'Segment');
            // æ¨¡ç³ŠåŒ¹é…ï¼šå¦‚æœå­˜å‚¨çš„å€¼ä¸åœ¨æŒ‰é’®é‡Œï¼ˆæ¯”å¦‚æ‰‹åŠ¨æ”¹è¿‡ï¼‰ï¼Œå°±ä¸é«˜äº®æˆ–é»˜è®¤é«˜äº®ä¸€ä¸ª
            const btns = container.querySelectorAll('.segment-btn');
            let found = false;
            
            btns.forEach(btn => {
                // ä» onclick å±æ€§ä¸­æå–æ•°å€¼ï¼Œæˆ–è€…ç®€å•çš„æ–‡æœ¬åŒ¹é…
                // è¿™é‡Œæˆ‘ä»¬å‡è®¾æŒ‰é’®çš„ onclick åŒ…å«è¯¥æ•°å€¼
                if (btn.getAttribute('onclick').includes(value)) {
                    btn.classList.add('active');
                    found = true;
                } else {
                    btn.classList.remove('active');
                }
            });
            
            document.getElementById('disp_' + type).innerText = value;
        }

        // é¡µé¢åŠ è½½è¯»å–é…ç½®
        window.onload = async () => {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                
                document.getElementById('apiKey').value = config.poe_api_key;
                document.getElementById('webSearch').checked = config.enable_web_search;
                
                // åŒæ­¥çŠ¶æ€
                state.claude_budget = config.claude_budget;
                state.gemini_budget = config.gemini_budget;
                state.gpt_effort = config.gpt_effort;

                // æ¸²æŸ“æŒ‰é’®çŠ¶æ€
                highlightBtnByValue('claude', config.claude_budget);
                highlightBtnByValue('gemini', config.gemini_budget);
                
                // æ¸²æŸ“ GPT æŒ‰é’®
                const gptContainer = document.getElementById('gptSegment');
                gptContainer.querySelectorAll('.segment-btn').forEach(b => {
                    b.classList.remove('active');
                    if(b.innerText.toLowerCase() === config.gpt_effort) b.classList.add('active');
                });
                document.getElementById('disp_gpt').innerText = config.gpt_effort.charAt(0).toUpperCase() + config.gpt_effort.slice(1);

            } catch(e) {
                console.error("åŠ è½½é…ç½®å¤±è´¥", e);
            }
        };

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const config = {
                poe_api_key: document.getElementById('apiKey').value,
                enable_web_search: document.getElementById('webSearch').checked,
                claude_budget: state.claude_budget,
                gemini_budget: state.gemini_budget,
                gpt_effort: state.gpt_effort
            };

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                const statusDiv = document.getElementById('status');
                if(res.ok) {
                    statusDiv.innerHTML = 'âœ… é…ç½®å·²å³æ—¶ç”Ÿæ•ˆ';
                    statusDiv.style.color = 'green';
                    statusDiv.classList.add('show');
                    setTimeout(() => statusDiv.classList.remove('show'), 2000);
                }
            } catch(e) {
                alert('è¿æ¥é”™è¯¯');
            }
        }
    </script>
</body>
</html>
"""

class ConfigModel(BaseModel):
    poe_api_key: str
    enable_web_search: bool
    claude_budget: int
    gemini_budget: int
    gpt_effort: str


# ================== 2. ç®¡ç†æ¥å£ ==================

@app.get("/", response_class=HTMLResponse)
async def serve_ui():
    return HTML_TEMPLATE

@app.get("/api/config")
async def get_config():
    return current_config

@app.post("/api/config")
async def set_config(config: ConfigModel):
    global current_config
    current_config = config.dict()
    print(f"\n[UI] é…ç½®æ›´æ–°: Claude={current_config['claude_budget']} | GPT={current_config['gpt_effort']}")
    return {"status": "success", "config": current_config}

# ================== 3. æ ¸å¿ƒä»£ç†é€»è¾‘ (å«è‡ªåŠ¨é‡è¯•ä¸é˜²æ–­è¿) ==================

@app.post("/v1/chat/completions")
async def chat_proxy(request: Request):
    # åŠ¨æ€è¯»å–
    cfg = current_config
    
    try:
        original_body = await request.json()
    except:
        original_body = {}

    model_name = original_body.get("model", "").lower()
    poe_payload = original_body.copy()
    
    # æ¸…ç†å‚æ•°
    for k in ["reasoning_effort", "thinking_budget"]:
        poe_payload.pop(k, None)
    
    if "extra_body" in poe_payload:
        extra = poe_payload.pop("extra_body")
        if isinstance(extra, dict): poe_payload.update(extra)

    injected = []

    # 1. æ³¨å…¥è”ç½‘
    if cfg["enable_web_search"]:
        poe_payload["web_search"] = True
        injected.append("Search:ON")

    # 2. æ³¨å…¥æ€è€ƒå‚æ•°
    if "claude" in model_name and cfg["claude_budget"] > 0:
        poe_payload["thinking_budget"] = cfg["claude_budget"]
        injected.append(f"Budget:{cfg['claude_budget']}")
    elif "gemini" in model_name and cfg["gemini_budget"] > 0:
        poe_payload["thinking_budget"] = cfg["gemini_budget"]
        injected.append(f"Budget:{cfg['gemini_budget']}")
    else:
        # GPT/O1
        if cfg["enable_web_search"] and cfg["gpt_effort"]:
            poe_payload["websearch_reasoning_effort"] = cfg["gpt_effort"]
            injected.append(f"Effort:{cfg['gpt_effort']}")

    print(f"-------------- è¯·æ±‚: {model_name} | {', '.join(injected)} --------------")
    
    headers = {"Content-Type": "application/json", "Authorization": f"Bearer {cfg['poe_api_key']}"}
    target_url = "https://api.poe.com/v1/chat/completions"

    # === å…³é”®ï¼šæŠ—æ–­è¿é…ç½® ===
    timeout_config = httpx.Timeout(connect=120.0, read=None, write=120.0, pool=None)

    async def upstream_generator():
        max_retries = 2
        async with httpx.AsyncClient(timeout=timeout_config, http2=False) as client:
            for attempt in range(max_retries):
                try:
                    async with client.stream("POST", target_url, json=poe_payload, headers=headers) as response:
                        if response.status_code != 200:
                            err = b"".join([chunk async for chunk in response.aiter_bytes()]).decode()
                            print(f"âŒ API æŠ¥é”™: {err}")
                            yield err.encode()
                            return
                        
                        async for chunk in response.aiter_bytes():
                            yield chunk
                        return # æˆåŠŸåˆ™é€€å‡º

                except Exception as e:
                    print(f"âš ï¸ è¿æ¥æ³¢åŠ¨ (å°è¯• {attempt+1}/{max_retries}): {e}")
                    if attempt == max_retries - 1:
                        yield f'{{"error": "Poe è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é™ä½æ€è€ƒå¼ºåº¦ã€‚\\nDetail: {str(e)}"}}'.encode()

    return StreamingResponse(upstream_generator(), media_type="text/event-stream")

if __name__ == "__main__":
    print("ğŸš€ Poe æ§åˆ¶å°å·²å¯åŠ¨: http://127.0.0.1:8001")
    uvicorn.run(app, host="127.0.0.1", port=8001)
